---
title: "WMH_Xsec"
output:
  pdf_document: default
  html_document: default
  word_document: default
editor_options:
  chunk_output_type: console
date: "Last compiled on `r format(Sys.time(), '%d %B %Y')`"
author: Tracy Melzer
---

Here are some plots and stats for the total WMH volume calculated using 4 different segmentation algorithms.

# Libraries
```{r, include=FALSE}
# 
#rm(list = ls())
setwd('/home/tracym/Documents/R/WMH_Xsec/')


#install.packages("devtools")
#install.packages("googlesheets")

library(devtools)
library(googlesheets)
#devtools::install_github("nzbri/chchpd", force = T)
library(chchpd)
library(rstan)
# start the multicore mode (Parallel compution)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

library(tidyverse)
library(plyr)
library(dplyr)
library(ggplot2)
library(ggfortify)
library("plotly")
library(brms)
library(lsmeans)
library(rcompanion)
library(pander)
#Display 2 digists in the lm outputs 
panderOptions("digits",2)
library(lm.beta)

#options(httr_oob_default = TRUE)
#googlesheets::gs_auth(key = "368441839817-ic37m1bdfqj8gohothmef2652usuc6kv.apps.googleusercontent.com", 
                      #secret = "uW1Rkrf7vAElXOgLcExO_vWr")


```


# Load MRI
```{r eval=FALSE, include=FALSE}
## WMH -- NOT checked by anyone yet. This is after running LGA on the whole dataset.


LGA <- read.csv('/home/tracym/scratch/WMH/LGA_outputs/LGA_WMH_vols_OCT2019.csv')
LPA <- read.csv('/home/tracym/scratch/WMH/LPA_outputs/LPA_WMH_vols_OCT2019.csv')
BIANCA <- read.csv('/home/tracym/scratch/WMH/BIANCA_outputs/BIANCA_WMH_vols_OCT2019.csv')
UBO <- read.csv('/home/tracym/scratch/WMH/UBO_outputs/UBO_WMH_vols_JAN2019.csv')

ICV <- read.csv('/home/tracym/scratch/WMH/ICV.csv')

## Add GM vol & WMH
#Import GM to get subject IDs & vbm8/lst WMHs.
#GM <- read.csv('all_MRI_JUNE2017.csv')

mri <- ICV %>%
  left_join(BIANCA,by="MRI") %>% 
  left_join(LGA,by="MRI") %>% 
  left_join(LPA,by="MRI") %>% 
  left_join(UBO,by="MRI")

```


# Load NP/clincial data
```{r eval=FALSE, include=FALSE}

# gathering NP data

participants = import_participants()
np = import_neuropsyc()
MRI_gs = import_MRI()
motor = import_motor_scores()
hads = import_HADS()
hall = import_hallucinations()
sessions = import_sessions(from_study = 'Follow-up') # contains ages
sessions_pdd = import_sessions(from_study = 'PDD Followup')
meds = import_medications()

#Annoying naming convention
MRI_gs$scan_number[MRI_gs$scan_number=='26467.66'] <- '26466'

#Deal with 6-month cognitive status
# np = separate(np, session_id, sep = "_", into = c("subject_id", "session_date"), remove = FALSE) %>%
#   group_by(subject_id) %>%
#   arrange(session_date) %>%
#   fill(cognitive_status) %>%
#   ungroup() %>%
#   select(-subject_id,-session_date)


#Grab the 4 subjects that are in the PDD FOllowup study (and not in the 'Follow-up' study according to Alice.)
#45148 026BIO
#45359 141ADL
#46612 009WLS
#48664 033ABW
ses <- filter(sessions_pdd, mri_scan_no=="45148" | mri_scan_no=="45359" | mri_scan_no=="46612" | mri_scan_no=="48664" | mri_scan_no=="22968" | mri_scan_no=="47212" | mri_scan_no=="47295")         #47295, 47212 in PDD study

#Add in the PDD Followup rows I'm missing 
sessions <- rbind(sessions,ses)



#Merge all the Google Docs data together
all_mri_dat = np %>% # controls which data will be selected
  left_join(sessions, by = 'session_id')%>%
  left_join(participants, by = 'subject_id')%>%
  left_join(MRI_gs, by = 'session_id') %>%
  left_join(motor, by = 'session_id') %>% 
  left_join(hads, by = 'session_id') %>% 
  left_join(meds, by = 'session_id') %>% 
  filter(mri_scan_no!="None") %>%         #Get rid of sessions without MRI scans
  filter(np_group!="PSP") %>%    #2 subjects excluded because PSP diagnosis: 43889 & 44894
  filter(np_group!="MSA") %>% 
  mutate(MRI = mri_scan_no)


#all_mri_dat$MRI <- factor(all_mri_dat$mri_scan_no)

#Merge the QSM data (mri) with the NP data by scan number
dat <- merge(all_mri_dat,mri,by="MRI")


##########
#####Need to sort
# 011RHB, MRI 2011 & 41346
# 034BIO developed macular degeneration -- need to exclude sessions from 2014 on. That means we need to exclude:35731 & 46137 (Ok to include previous: 6671, 15027, 19973, 26462)


dat <- dat %>% 
  filter(subject_id!='011RHB') %>% 
  filter(MRI!="35731") %>% 
  filter(MRI!="41346")

#Get rid of repeated 101BIO 22968
dat <- dat[!duplicated(dat$MRI),]

#Make comparable datatypes
all_mri_dat$MRI <- as.numeric(all_mri_dat$MRI)

# #Which scans are missing
missing <- anti_join(all_mri_dat,mri,by="MRI")


```



# Data wrangle
```{r eval=FALSE, include=FALSE}

####  ********************************
# Make sure that every baseline scan is always 0 years from baseline.
# At the moment, some individuals weren't scanned until 2 or 4 or 5 years after their baseline NP assessment.

#Create new column: Years from baseline scan "yfbs""
# This is 'years from baseline scan'
dat[,"yfbs"] <- NA

b<-unique(dat$subject_id)

#Loop through the unique IDs
for (i in 1:length(b))

{ c <- dat$age[dat$subject_id==b[i]]
 d <- dat$subject_id==b[i] & dat$age==min(c)

 
 #If years_from_baseline is zero, then copy years_from_baseline values into new variable yfbs. 
 # But, if years from baseline (at the time of first scan) is not equal to 0, then subtract the amount of time at the first assessment.
  if (dat$years_from_baseline[d]==0) {
     dat$yfbs[dat$subject_id==b[i]] <- dat$years_from_baseline[dat$subject_id==b[i]]
  } else if (dat$years_from_baseline[d]!=0) {
    dat$yfbs[dat$subject_id==b[i]] <- dat$years_from_baseline[dat$subject_id==b[i]] - dat$years_from_baseline[d]
}
}



### **********************************************
###   Find longest followup time (FU_latest)
#Set up new variable (FU_latest)
dat[,"FU_latest"]<-NA

#Find dathere unique IDs
b<-unique(dat$subject_id)

#Loop through the unique IDs
for (i in 1:length(b))

{ c <- dat$age[dat$subject_id==b[i]]
 d <- dat$subject_id==b[i] & dat$age==max(c)
  
  dat$FU_latest[dat$subject_id==b[i]] <- dat$yfbs[d]
}


#####*******************************

#Create full dataset
#dat.all <- merge(dat,GM,by="MRI")


#write.csv(dat,"ASL_data_merged_20JUNE.csv")


```


# Baseline dataset
```{r eval=FALSE, include=FALSE}

#I'm currently excluding the Control-MCI group as there are only n=2.
dat.base <- dat %>% 
  filter(yfbs==0) %>%
  filter(diagnosis!='Control-MCI') %>% 
  mutate(subject_id = factor(subject_id)) %>% 
  mutate(diagnosis = factor(diagnosis)) %>% 
  mutate(age_s10 = scale(age, center=TRUE, scale=FALSE)/10) %>% 
  mutate(group = factor(np_group)) %>% 
  mutate(icv_dm = scale(ICV,center=TRUE,scale=FALSE)/10)%>% 
  mutate(diagnosis = fct_relevel(diagnosis, "Control-N", "PD-N", "PD-MCI", "PDD"))%>% 
  mutate(lga.icv = (100*(lga/ICV))) %>% 
  mutate(lpa.icv = (100*(lpa/ICV))) %>% 
  mutate(bianca.icv = (100*(bianca/ICV))) %>% 
  mutate(ubo.icv = (100*(ubo/ICV))) %>% 
  filter(!is.na(bianca)) %>%     #Get rid of any missing data (n=1 @ baseline)
  filter(!is.na(lpa)) %>%     #n=0
  filter(!is.na(lga)) %>%     #n=0
  filter(!is.na(ubo))      #n=2

```


# Read in data
```{r, include=FALSE }

#Write out 2 dataframes to avoid running above everytime.
#write.csv(dat.base, file = "dat_base.csv")
#write.csv(dat.plot.base, file = "dat_plot_base.csv")

dat.base <- read.csv("dat_base.csv")

#Reorder diagnosis
dat.base <- dat.base %>% 
  mutate(diagnosis = fct_relevel(diagnosis, "Control-N", "PD-N", "PD-MCI", "PDD"))


#Load up performance metrics as well
p.metrics = read.csv("performance_measures.csv")

p.metrics <- p.metrics %>% 
  mutate(ID = factor(ID))
```
 
\newpage
# Performance metrics
## Table
Here is a summary table of the performance metrics based on the 40 manually-traced gold standard WMH masks.  

```{r performance metrics, echo=FALSE}

p.metrics %>% 
  group_by(algorithm) %>% 
  summarise(mean_SI = mean(SI), sd_SI = sd(SI), 
            mean_FPRc = mean(FPR_clusters), 
            mean_FNRc = mean(FNR_clusters)) %>% 
  knitr::kable()

```


## Plot
A plot of the Dice Similarity Coefficient across the 4 methods in the training sample of n=40.    
```{r, echo=FALSE, warning=FALSE}

#colours <- c("#6495ED","#00008B","#339900",  "#FF9326", "#D92121")
p.metrics %>% 
  ggplot(aes(x=reorder(algorithm,-SI),y=SI)) +
  geom_boxplot(outlier.shape=NA, width=0.8) +
  #geom_line(aes(group=ID),alpha=0.2)+
  geom_point(aes(color=algorithm), position = position_jitter(width=0.15),size=2.5) +
  ylab("Dice Similarity Coefficient") + xlab("") +
  theme(legend.position = "none") +
  theme(axis.text.x=element_text(face="bold",size=15, color="black")) 
ggsave("SI_metrics.pdf",width=8,height=5)


```


## Stats
```{r, echo=FALSE}

si.mod <- lm(SI ~ algorithm, data=p.metrics)
pander(si.mod)

```


# Summarise
A few summary demographics from the entire baseline cohort.  
## Age
```{r, echo=FALSE}

dat.base %>% 
  group_by(diagnosis) %>% 
  dplyr::summarise(n(), age_m = mean(age), std = sd(age)) %>% 
  knitr::kable()

```

## Sex  
```{r, echo=FALSE}

dat.base %>% 
  group_by(diagnosis,sex) %>% 
  dplyr::summarise(n()) %>% 
  knitr::kable()

```


# Method Comparison:Baseline
## Data wrangle
```{r, include=FALSE}
dat.plot.base <- dat.base %>% 
  gather(method,wmh, c(`bianca`,`lga`,`lpa`, `ubo`))%>%
  mutate(method=factor(method)) %>% 
  mutate(method = fct_relevel(method,"lga","lpa","bianca", "ubo" )) %>% 
  mutate(diagnosis = fct_relevel(diagnosis, "Control-N", "PD-N", "PD-MCI", "PDD"))%>% 
  mutate(diagnosis = revalue(diagnosis,c("Control-N" = "Control"))) %>% 
  mutate(wmh.icv = wmh/ICV) 

```


\newpage
## Figure: PD vs HC
Plot PD vs controls for the 4 methods.  
\hfill\break
```{r, echo=FALSE, warning=FALSE}

#colours <- c("#6495ED","#00008B","#339900",  "#FF9326","#D92121")
colours <- c("#6495ED", "#339900",  "#FF9326","#D92121")
dat.plot.base %>% 
  ggplot(aes(x=np_group,y=(wmh+1))) +
  #geom_violin()+
  geom_boxplot(outlier.shape=NA, width=0.8) +
  geom_point(aes(color=diagnosis), position = position_jitter(width=0.15), alpha=0.6, size=1) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  xlab("") +
  scale_y_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  facet_wrap(~method) +
  theme(axis.text.x = element_text(angle=-45,hjust=0.1))
  ggsave("WMH_Group_4method_facet_method_JAN2020.pdf",width=10,height=5)


```

\newpage
## Figure: ADJUSTED PD vs HC
Plot the residuals from a model adjusting for age, sex, and ICV.  
\hfill\break
```{r, echo=FALSE, warning=FALSE}

dat.base$resid.diag.lga <- residuals(lm(log(lga+1)~age_s10 + sex + icv_dm ,dat=dat.base))
dat.base$resid.diag.lpa <- residuals(lm(log(lpa+1)~age_s10 + sex + icv_dm ,dat=dat.base))
dat.base$resid.diag.bianca <- residuals(lm(log(bianca+1)~age_s10 + sex + icv_dm ,dat=dat.base))
dat.base$resid.diag.ubo <- residuals(lm(log(ubo+1)~age_s10 + sex + icv_dm ,dat=dat.base))

dat.plot.base.adjust <- dat.base %>% 
  #gather(method,wmh, c(`bianca`,`lga`,`lpa`, `ubo`) )%>%
  gather(method,resid, c(`resid.diag.bianca`,`resid.diag.lga`,`resid.diag.lpa`, `resid.diag.ubo`))%>%
  mutate(method=factor(method)) %>% 
  mutate(method = factor(method, labels = c('bianca', 'lga', 'lpa', 'ubo'))) %>% 
  mutate(method = fct_relevel(method,"lga","lpa","bianca", "ubo" )) %>% 
  mutate(diagnosis = fct_relevel(diagnosis, "Control-N", "PD-N", "PD-MCI", "PDD"))%>% 
  mutate(diagnosis = revalue(diagnosis,c("Control-N" = "Control"))) 
 



#colours <- c("#6495ED","#00008B","#339900",  "#FF9326","#D92121")
colours <- c("#6495ED", "#339900",  "#FF9326","#D92121")
dat.plot.base.adjust %>% 
  ggplot(aes(x=np_group,y=resid)) +
  #geom_violin()+
  geom_boxplot(outlier.shape=NA, width=0.8) +
  geom_point(aes(color=diagnosis), position = position_jitter(width=0.15), alpha=0.6, size=1) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  xlab("") +
  ylab("WMH adjusted for age, sex, and ICV")+
  #scale_y_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  facet_wrap(~method) +
  theme(axis.text.x = element_text(angle=-45,hjust=0.1))
  ggsave("WMH_ADJUSTED_GROUP_4method_facet_method_JAN2020.pdf",width=10,height=5)

  


```



\newpage
## Figure: Diagnosis by Method
\hfill\break
```{r, echo=FALSE, warning=FALSE}

#colours <- c("#6495ED","#00008B","#339900",  "#FF9326","#D92121")
colours <- c("#6495ED", "#339900",  "#FF9326","#D92121")
dat.plot.base %>% 
  ggplot(aes(x=diagnosis,y=(wmh+1))) +
  #geom_violin()+
  geom_boxplot(outlier.shape=NA, width=0.8) +
  geom_point(aes(color=diagnosis), position = position_jitter(width=0.15), alpha=0.6, size=1) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  xlab("") +
  scale_y_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  facet_wrap(~method) +
  theme(axis.text.x = element_text(angle=-45,hjust=0.1))
  ggsave("WMH_4method_facet_method_JAN2020.pdf",width=10,height=5)

  
#Adjusted for age and sex

```

\newpage
## Figure: ADJUSTED Diagnosis by Method  
Plot the residuals from a model adjusting for age, sex, and ICV.  
\hfill\break
```{r, echo=FALSE, warning=FALSE}

dat.base$resid.diag.lga <- residuals(lm(log(lga+1)~age_s10 + sex + icv_dm ,dat=dat.base))
dat.base$resid.diag.lpa <- residuals(lm(log(lpa+1)~age_s10 + sex + icv_dm ,dat=dat.base))
dat.base$resid.diag.bianca <- residuals(lm(log(bianca+1)~age_s10 + sex + icv_dm ,dat=dat.base))
dat.base$resid.diag.ubo <- residuals(lm(log(ubo+1)~age_s10 + sex + icv_dm ,dat=dat.base))

dat.plot.base.adjust <- dat.base %>% 
  #gather(method,wmh, c(`bianca`,`lga`,`lpa`, `ubo`) )%>%
  gather(method,resid, c(`resid.diag.bianca`,`resid.diag.lga`,`resid.diag.lpa`, `resid.diag.ubo`))%>%
  mutate(method=factor(method)) %>% 
  mutate(method = factor(method, labels = c('bianca', 'lga', 'lpa', 'ubo'))) %>% 
  mutate(method = fct_relevel(method,"lga","lpa","bianca", "ubo" )) %>% 
  mutate(diagnosis = fct_relevel(diagnosis, "Control-N", "PD-N", "PD-MCI", "PDD"))%>% 
  mutate(diagnosis = revalue(diagnosis,c("Control-N" = "Control"))) 
 



#colours <- c("#6495ED","#00008B","#339900",  "#FF9326","#D92121")
colours <- c("#6495ED", "#339900",  "#FF9326","#D92121")
dat.plot.base.adjust %>% 
  ggplot(aes(x=diagnosis,y=resid)) +
  #geom_violin()+
  geom_boxplot(outlier.shape=NA, width=0.8) +
  geom_point(aes(color=diagnosis), position = position_jitter(width=0.15), alpha=0.6, size=1) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  xlab("") +
  ylab("WMH adjusted for age, sex, and ICV")+
  #scale_y_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  facet_wrap(~method) +
  theme(axis.text.x = element_text(angle=-45,hjust=0.1))
  ggsave("WMH_ADJUSTED_4method_facet_method_JAN2020.pdf",width=10,height=5)

  


```


\hfill\break
\newpage
# ANALYSIS
## Group
Simple PD vs Control comparisons across the 4 WMH segmentation algorithms.  
```{r, echo=FALSE }

lm.pd.lga <- lm(log(lga+1) ~ age_s10 + sex + icv_dm + group, data=dat.base)
#summary(lm.pd.lga)
#pander(lm.pd.lga)
lm.pd.lga.log <- glm(I(lga+1) ~ age_s10 + sex + icv_dm + group, data=dat.base, family=gaussian(link="log"))
summary(lm.pd.lga.log)
#Use the lm.beta package to produce standardized betas to allow a better comparison across the different models.
lm.pd.lga.beta <- lm.beta(lm.pd.lga)
pander(lm.pd.lga.beta)

lm.pd.lpa <- lm(log(lpa+1) ~ age_s10 + sex + icv_dm + group, data=dat.base)
#summary(lm.pd.lpa)
#pander(lm.pd.lpa)
lm.pd.lpa.beta <- lm.beta(lm.pd.lpa)
pander(lm.pd.lpa.beta)

lm.pd.bianca <- lm(log(bianca+1) ~ age_s10 + sex + icv_dm + group, data=dat.base)
#summary(lm.pd.bianca)
#pander(lm.pd.bianca)
lm.pd.bianca.beta <- lm.beta(lm.pd.bianca)
pander(lm.pd.bianca.beta)

lm.pd.ubo <- lm(log(ubo+1) ~ age_s10 + sex + icv_dm + group, data=dat.base)
#summary(lm.pd.ubo)
#pander(lm.pd.ubo)
lm.pd.ubo.beta <- lm.beta(lm.pd.ubo)
pander(lm.pd.ubo.beta)

```

\newpage
## Diagnosis
```{r, echo=FALSE, results='asis', fig.width=4,fig.height=3 }


##LGA
##**********************
lm.diagnosis.lga.lm <- lm(I(log(lga+1)) ~ age_s10 + sex + icv_dm + diagnosis, data=dat.base)
lm.diagnosis.lga.glm <- glm(I(lga+1) ~ age_s10 + sex + icv_dm + diagnosis, data=dat.base,family=gaussian(link="log"))

plot(lm.diagnosis.lga.lm)
plot(lm.diagnosis.lga.glm)

#summary(lm.diagnosis.lga)
lm.diagnosis.lga.lsm <- lsmeans::lsmeans(lm.diagnosis.lga, pairwise~diagnosis, adjust="tukey")
#pander(lm.diagnosis.lga)

#Get standardized betas
lm.diagnosis.lga <- lm.beta(lm.diagnosis.lga)
pander(lm.diagnosis.lga)

#cat("\n\n\\newpage\n")
lm.diagnosis.lga.pairwise <- ref_grid(lm.diagnosis.lga)
lm.diagnosis.lga.emm <- emmeans(lm.diagnosis.lga.pairwise, tukey ~ diagnosis)

plot(lm.diagnosis.lga.emm, xlab="LGA")
ggsave("LGA_emm.pdf",width=8,height=5)

cat(" \n")
plot(lm.diagnosis.lga.emm$contrasts,xlab="LGA")
ggsave("LGA_diagnosis_pairwise.pdf",width=8,height=5)

##******************************************************


cat("\n\n\\newpage\n")


##LPA
##*********************************************************
lm.diagnosis.lpa <- lm(log(lpa+1) ~ age_s10 + sex + icv_dm + diagnosis, data=dat.base)
#pander(lm.diagnosis.lpa)
lm.diagnosis.lpa.lsm <- lsmeans::lsmeans(lm.diagnosis.lpa, pairwise~diagnosis, adjust="tukey")
#lm.diagnosis.lpa.lsm

#Get standardized betas
lm.diagnosis.lpa <- lm.beta(lm.diagnosis.lpa)
pander(lm.diagnosis.lpa)

lm.diagnosis.lpa.pairwise <- ref_grid(lm.diagnosis.lpa)
lm.diagnosis.lpa.emm <- emmeans(lm.diagnosis.lpa.pairwise, tukey ~ diagnosis)

plot(lm.diagnosis.lpa.emm,xlab="LPA")
ggsave("LPA_emm.pdf",width=8,height=5)

cat(" \n")
plot(lm.diagnosis.lpa.emm$contrasts,xlab="LPA")
ggsave("LPA_diagnosis_pairwise.pdf",width=8,height=5)

##******************************************************


cat("\n\n\\newpage\n")


##BIANCA
##**************************************************
lm.diagnosis.bianca <- lm(log(bianca+1) ~ age_s10 + sex + icv_dm + diagnosis, data=dat.base)
#pander(lm.diagnosis.bianca)
lm.diagnosis.bianca.lsm <- lsmeans::lsmeans(lm.diagnosis.bianca, pairwise~diagnosis, adjust="tukey")
#lm.diagnosis.bianca.lsm

#Get standardized betas
lm.diagnosis.bianca <- lm.beta(lm.diagnosis.bianca)
pander(lm.diagnosis.bianca)

lm.diagnosis.bianca.pairwise <- ref_grid(lm.diagnosis.bianca)
lm.diagnosis.bianca.emm <- emmeans(lm.diagnosis.bianca.pairwise, tukey ~ diagnosis)

plot(lm.diagnosis.bianca.emm, xlab="BIANCA")
ggsave("BIANCA_emm.pdf",width=8,height=5)

#Adds a line break in the pdf
cat(" \n")
plot(lm.diagnosis.bianca.emm$contrasts,  xlab="BIANCA")
ggsave("BIANCA_diagnosis_pairwise.pdf",width=8,height=5)

##******************************************************

cat("\n\n\\newpage\n")

##UBO
##*************************************************
lm.diagnosis.ubo <- lm(log(ubo+1) ~ age_s10 + sex + icv_dm + diagnosis, data=dat.base)
#pander(lm.diagnosis.ubo)
lm.diagnosis.ubo.lsm <- lsmeans::lsmeans(lm.diagnosis.ubo, pairwise~diagnosis, adjust="tukey")
#lm.diagnosis.ubo.lsm

lm.diagnosis.ubo <- lm.beta(lm.diagnosis.ubo)
pander(lm.diagnosis.ubo)

lm.diagnosis.ubo.pairwise <- ref_grid(lm.diagnosis.ubo)
lm.diagnosis.ubo.emm <- emmeans(lm.diagnosis.ubo.pairwise, tukey ~ diagnosis)

plot(lm.diagnosis.ubo.emm, xlab="UBO")
ggsave("UBO_emm.pdf",width=8,height=5)

#Adds a line in the PDF
cat(" \n")
plot(lm.diagnosis.ubo.emm$contrasts, xlab="UBO")
ggsave("UBO_diagnosis_pairwise.pdf",width=8,height=5)

##******************************************************


```

\newpage
## Cogz in PD
\hfill\break
Regressions between log(WMH+1) and Cogz aross the 4 methods.
There is a model comparison within-method to determine the best model. The model with cogz~log(wmh+1) turns out to be the best (with the smallest AIC and BIC) in all 4 cases.
```{r, echo=FALSE}

#Run just in PD
dat.base.pd <- dat.base %>% 
  filter(group=='PD') %>% 
  mutate(group=factor(group)) %>% 
  mutate(diagnosis=factor(diagnosis))

#2 step model comparison. 1st, confirm which of the models within each method is the best, then compare the best model across methods to each other. 

#***LGA***
########################################
cogz.pd.lga.r <- lm(global_z ~ age_s10 + sex + lga.icv, data=dat.base.pd )
pander(cogz.pd.lga.r)

cogz.pd.lga.ln <- lm(global_z ~ age_s10 + sex + log(lga+1), data=dat.base.pd )
pander(cogz.pd.lga.ln)

cogz.pd.lga.ln.icv <- lm(global_z ~ age_s10 + sex + log(lga+1) + icv_dm, data=dat.base.pd )
pander(cogz.pd.lga.ln.icv)

#Compare across the three within-method models
anova(cogz.pd.lga.r, cogz.pd.lga.ln, cogz.pd.lga.ln.icv)

#Get AIC for within-method models
pander(compareLM(cogz.pd.lga.r, cogz.pd.lga.ln, cogz.pd.lga.ln.icv))

########################################


#***LPA***
########################################
cogz.pd.lpa.r <- lm(global_z ~ age_s10 + sex + lpa.icv, data=dat.base.pd )
pander(cogz.pd.lpa.r)

cogz.pd.lpa.ln <- lm(global_z ~ age_s10 + sex + log(lpa+1), data=dat.base.pd )
pander(cogz.pd.lpa.ln)

cogz.pd.lpa.ln.icv <- lm(global_z ~ age_s10 + sex + log(lpa+1) + icv_dm, data=dat.base.pd )
pander(cogz.pd.lpa.ln.icv)

#Compare across the three within-method models
anova(cogz.pd.lpa.r, cogz.pd.lpa.ln, cogz.pd.lpa.ln.icv)

#Get AIC for within-method models
pander(compareLM(cogz.pd.lpa.r, cogz.pd.lpa.ln, cogz.pd.lpa.ln.icv))

########################################


#***BIANCA***
########################################
cogz.pd.bianca.r <- lm(global_z ~ age_s10 + sex + bianca.icv, data=dat.base.pd )
pander(cogz.pd.bianca.r)

cogz.pd.bianca.ln <- lm(global_z ~ age_s10 + sex + log(bianca+1), data=dat.base.pd )
pander(cogz.pd.bianca.ln)

cogz.pd.bianca.ln.icv <- lm(global_z ~ age_s10 + sex + log(bianca+1) + icv_dm, data=dat.base.pd )
pander(cogz.pd.bianca.ln.icv)

#Compare across the three within-method models
anova(cogz.pd.bianca.r, cogz.pd.bianca.ln, cogz.pd.bianca.ln.icv)

#Get AIC for within-method models
pander(compareLM(cogz.pd.bianca.r, cogz.pd.bianca.ln, cogz.pd.bianca.ln.icv))

########################################


#***UBO***
########################################
cogz.pd.ubo.r <- lm(global_z ~ age_s10 + sex + ubo.icv, data=dat.base.pd )
pander(cogz.pd.ubo.r)

cogz.pd.ubo.ln <- lm(global_z ~ age_s10 + sex + log(ubo+1), data=dat.base.pd )
pander(cogz.pd.ubo.ln)

cogz.pd.ubo.ln.icv <- lm(global_z ~ age_s10 + sex + log(ubo+1) + icv_dm, data=dat.base.pd )
pander(cogz.pd.ubo.ln.icv)

#Compare across the three within-method models
anova(cogz.pd.ubo.r, cogz.pd.ubo.ln, cogz.pd.ubo.ln.icv)

#Get AIC for within-method models
pander(compareLM(cogz.pd.ubo.r, cogz.pd.ubo.ln, cogz.pd.ubo.ln.icv))

########################################


  
```


\newpage
# Cogz standardized betas  
This calculates and reports the standardized betas for the model with the lowest AIC for each method.  
```{r, echo=FALSE}

cogz.pd.lga.ln <- lm.beta(cogz.pd.lga.ln)
pander(cogz.pd.lga.ln)

cogz.pd.lpa.ln <- lm.beta(cogz.pd.lpa.ln)
pander(cogz.pd.lpa.ln)

cogz.pd.bianca.ln <- lm.beta(cogz.pd.bianca.ln)
pander(cogz.pd.bianca.ln)


cogz.pd.ubo.ln <- lm.beta(cogz.pd.ubo.ln)
pander(cogz.pd.ubo.ln)


```


\newpage
# Figures
## Cogz in PD
\hfill\break
```{r, echo=FALSE, warning=FALSE}

#Not adjusted for age or sex (age explains most of the variance.)
colours <- c( "#339900",  "#FF9326","#D92121")
dat.plot.base %>% 
  filter(np_group=='PD') %>% 
  ggplot(aes(x=(wmh+1),y=global_z)) +
  #geom_violin()+
  geom_point(aes(color=diagnosis), alpha=0.6) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  scale_x_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  ylab("Global cognitive ability") +
  facet_wrap(~method) +
  stat_smooth(method="lm", color='black') 
  #theme(axis.text.x = element_text(angle=-45,hjust=0.1))
  ggsave("Cogz-WMH_4method_facet_method_FEB2020.pdf",width=10,height=5)

  

```

\newpage
## Account for covariates
This plot adjusts for age and sex.
\hfill\break
```{r, echo=FALSE, warning=FALSE}

#Plot Cogz ~ wmh, adjusting for age and sex. 

dat.base.pd.clean <- dat.base.pd %>% 
  filter(global_z!='NA')
dat.base.pd.clean$resid <- residuals(lm(global_z ~ age_s10 + sex, data=dat.base.pd.clean))

dat.plot.base.clean <- dat.base.pd.clean %>% 
  gather(method,wmh, c(`bianca`,`lga`,`lpa`, `ubo`))%>%
  mutate(method=factor(method)) %>% 
  mutate(method = fct_relevel(method,"lga","lpa","bianca", "ubo" )) %>% 
  mutate(diagnosis = fct_relevel(diagnosis, "PD-N", "PD-MCI", "PDD"))%>% 
  mutate(wmh.icv = wmh/ICV)

colours <- c( "#339900",  "#FF9326","#D92121")
dat.plot.base.clean %>% 
  filter(np_group=='PD') %>% 
  ggplot(aes(x=(wmh+1),y=resid)) +
  #geom_violin()+
  geom_point(aes(color=diagnosis), alpha=0.6) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  scale_x_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  ylab("Global cognitive ability (adjusted for age and sex)") +
  facet_wrap(~method) +
  stat_smooth(method="lm", color='black') 
  #theme(axis.text.x = element_text(angle=-45,hjust=0.1))
  ggsave("Cogz-WMH_ADJUSTED_4method_facet_method_FEB2020.pdf",width=10,height=5)

```



# Extra stuff
## Figure: BOX Facet:Diagnosis 
```{r Method compare, echo=FALSE, warning=FALSE, include=FALSE, eval=FALSE}

#colours <- c("#6495ED","#00008B","#339900",  "#FF9326","#D92121")
colours <- c("#6495ED", "#339900",  "#FF9326","#D92121")
dat.plot.base %>% 
  ggplot(aes(x=method,y=(wmh+1))) +
  geom_boxplot(outlier.shape=NA, width=0.8) +
  geom_point(aes(color=diagnosis), position = position_jitter(width=0.15),alpha=0.7,size=0.5) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  xlab("") +
  scale_y_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  facet_wrap(~diagnosis)
  #theme(legend.position = c(0.8,0.25))

  ggsave("WMH_4method_facet_diagnosis_JAN2020.pdf",width=8,height=5)
  


```


## Figure: Violin Facet:Diagnosis
```{r, echo=FALSE, warning=FALSE, eval=FALSE}
#colours <- c("#6495ED","#00008B","#339900",  "#FF9326","#D92121")
colours <- c("#6495ED", "#339900",  "#FF9326","#D92121")  

dat.plot.base %>% 
  ggplot(aes(x=method,y=(wmh+1))) +
  #geom_boxplot(outlier.shape=NA, width=0.8) +
  geom_violin()+
  geom_point(aes(color=diagnosis), position = position_jitter(width=0.15),alpha=0.7) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  xlab("") +
  scale_y_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  facet_wrap(~diagnosis) +
  #theme(legend.position = c(0.8,0.25))
  ggsave("WMH_4method_facet_diagnosis_JAN2020_violin.pdf",width=8,height=5)
```



## Figure: Violin Mean+SE
```{r, echo=FALSE,include=FALSE, warning=FALSE}

dat.plot.base.m <- dat.plot.base %>%
  group_by(diagnosis,method)%>%
  summarise(m = mean(wmh+1), s = sd(wmh+1), n =n(), se = s/sqrt(n))

  dat.plot.base.m %>% 
  ggplot(aes(x=method,y=m)) +
    geom_violin(data=dat.plot.base,aes(x=method,y=(wmh+1)), alpha=0.8)+
    geom_errorbar(aes(ymin=m-se, ymax=m+se),width=0)+
    geom_point(aes(color=method)) +
  #geom_boxplot(outlier.shape=NA, width=0.8) +
  #geom_violin()+
  #geom_point(aes(color=diagnosis), position = position_jitter(width=0.15),alpha=0.7) +
  #scale_colour_manual (values=colours,name = "method") + 
  xlab("") +
  scale_y_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  facet_wrap(~diagnosis) +
  #theme(legend.position = c(0.8,0.25))
  ggsave("WMH_4method_facet_diagnosis_JAN2020_mean_se_violin.pdf",width=8,height=5)
  
  
```



## Figure: Violin

```{r, echo=FALSE, warning=FALSE, eval=FALSE}
#colours <- c("#6495ED","#00008B","#339900",  "#FF9326","#D92121")
colours <- c("#6495ED", "#339900",  "#FF9326","#D92121")
dat.plot.base %>% 
  ggplot(aes(x=diagnosis,y=(wmh+1))) +
  geom_violin(alpha=0.8)+
  #geom_boxplot(outlier.shape=NA, width=0.8) +
  geom_point(aes(color=diagnosis), position = position_jitter(width=0.15), alpha=0.4,size=1) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  xlab("") +
  scale_y_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  facet_wrap(~method) +
  theme(axis.text.x = element_text(angle=-45,hjust=0.1))
  ggsave("WMH_4method_facet_method_OCT2020_violin.pdf",width=10,height=5)
  

```


## Figure: Correlation

```{r, ehco=FALSE, warning=FALSE, eval=FALSE, include=FALSE}

#colours <- c("#6495ED","#00008B","#339900",  "#FF9326","#D92121")
colours <- c("#6495ED", "#339900",  "#FF9326","#D92121")

dat.plot.base %>% 
  ggplot(aes(x=wmh+1,y=global_z)) +
  stat_smooth(aes(group=group),method="lm", color='black') +
  geom_point(aes(color=diagnosis)) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  scale_x_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  ylab("Global cognitive z") +
  facet_wrap(~method) +
  ggsave("Cogz_WMH_correlation_method_face_bygroup.pdf",width=12,height=5)


```


## Figure: Age

```{r, echo=FALSE, warning=FALSE, include=FALSE}
colours <- c("#6495ED", "#339900",  "#FF9326","#D92121")

dat.plot.base %>% 
  ggplot(aes(x=wmh+1,y=age)) +
  stat_smooth(aes(group=group),method="lm", color='black') +
  geom_point(aes(color=diagnosis)) +
  scale_colour_manual (values=colours,name = "diagnosis") + 
  scale_x_log10('1 + White Matter Hyperintensities (ml)',limits=c(0.9, 100)) +
  ylab("Global cognitive z") +
  facet_wrap(~method) +
  ggsave("age_WMH_correlation_method_face_bygroup.pdf",width=12,height=5)
```

## Cogz Model Compare
Here is a between-method model comparison. The 'best' model is determined by AIC.
```{r, echo=FALSE, include=FALSE}

anova(cogz.pd.lga.ln, cogz.pd.lpa.ln, cogz.pd.bianca.ln, cogz.pd.ubo.ln)

pander(compareLM(cogz.pd.lga.ln, cogz.pd.lpa.ln, cogz.pd.bianca.ln, cogz.pd.ubo.ln))


```
